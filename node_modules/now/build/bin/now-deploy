#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(o[r]=e[r]);return o["default"]=e,o}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function printLogs(e){var o=new _buildLogger2["default"](e);o.on("error",function(){console.log("> Connection error."),process.exit(1)}),o.on("close",function(){console.log(""+_chalk2["default"].cyan("> Deployment complete!")),process.exit(0)})}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),sync=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function o(e){var r,n,t,a,l,i;return _regenerator2["default"].wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return r=Date.now(),console.log('> Deploying "'+path+'"'),n=new _lib2["default"](apiUrl,e,{debug:debug}),o.prev=3,o.next=6,n.create(path,{forceNew:force,forceSync:forceSync});case 6:o.next=12;break;case 8:o.prev=8,o.t0=o["catch"](3),(0,_error.handleError)(o.t0),process.exit(1);case 12:if(t=n.url,a=(0,_ms2["default"])(new Date-r),!clipboard){o.next=26;break}return o.prev=15,o.next=18,(0,_copy2["default"])(t);case 18:console.log(_chalk2["default"].cyan("> Ready!")+" "+_chalk2["default"].bold(t)+" (copied to clipboard) ["+a+"]"),o.next=24;break;case 21:o.prev=21,o.t1=o["catch"](15),console.log(_chalk2["default"].cyan("> Ready!")+" "+_chalk2["default"].bold(t)+" ["+a+"]");case 24:o.next=27;break;case 26:console.log("> "+t+" ["+a+"]");case 27:l=new Date,i=function(){var e=(0,_ms2["default"])(new Date-l);console.log("> Sync complete ("+(0,_bytes2["default"])(n.syncAmount)+") ["+e+"] "),console.log("> Initializing‚Ä¶"),n.close(),printLogs(n.host)},n.syncAmount?!function(){var e=new _progress2["default"]("> Upload [:bar] :percent :etas",{width:20,complete:"=",incomplete:"",total:n.syncAmount});n.upload(),n.on("upload",function(o){var r=o.names,n=o.data,t=n.length;debug&&console.log("> [debug] Uploaded: "+r.join(" ")+" ("+(0,_bytes2["default"])(n.length)+")"),e.tick(t)}),n.on("complete",i),n.on("error",function(e){(0,_error.error)("Upload failed"),(0,_error.handleError)(e),process.exit(1)})}():(console.log("> Initializing‚Ä¶"),n.close(),printLogs(n.host));case 30:case"end":return o.stop()}},o,this,[[3,8],[15,21]])}));return function(o){return e.apply(this,arguments)}}(),_progress=require("progress"),_progress2=_interopRequireDefault(_progress),_copy=require("../lib/copy"),_copy2=_interopRequireDefault(_copy),_path=require("path"),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_package=require("../../package"),_buildLogger=require("../lib/build-logger"),_buildLogger2=_interopRequireDefault(_buildLogger),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_error=require("../lib/error"),argv=(0,_minimist2["default"])(process.argv.slice(2),{"boolean":["help","version","debug","force","login","no-clipboard"],alias:{help:"h",debug:"d",version:"v",force:"f",forceSync:"F",login:"L","no-clipboard":"C"}}),help=function(){console.log("\n  "+_chalk2["default"].bold("ùö´ now")+" [options] <command | path>\n\n  "+_chalk2["default"].dim("Commands:")+"\n\n    deploy       [path]       performs a deployment "+_chalk2["default"].bold("(default)")+"\n    ls | list    [app]        list deployments\n    rm | remove  [id]         remove a deployment\n    ln | alias   [id] [url]   configures aliases for deployments\n    domains      [name]       manages your domain names\n    help         [cmd]        displays complete help for [cmd]\n\n  "+_chalk2["default"].dim("Options:")+"\n\n    -h, --help          output usage information\n    -v, --version       output the version number\n    -d, --debug         debug mode [off]\n    -f, --force         force a new deployment even if nothing has changed\n    -L, --login         configure login\n    -C, --no-clipboard  do not attempt to copy URL to clipboard\n\n  "+_chalk2["default"].dim("Examples:")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Deploys the current directory\n\n    "+_chalk2["default"].cyan("$ now")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Deploys a custom path "+_chalk2["default"].dim("`/usr/src/project`")+"\n\n    "+_chalk2["default"].cyan("$ now /usr/src/project")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Lists all deployments with their IDs\n\n    "+_chalk2["default"].cyan("$ now ls")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Associates deployment "+_chalk2["default"].dim("`deploymentId`")+" with "+_chalk2["default"].dim("`custom-domain.com`")+"\n\n    "+_chalk2["default"].cyan("$ now alias deploymentId custom-domain.com")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Displays comprehensive help for the subcommand "+_chalk2["default"].dim("`list`")+"\n\n    "+_chalk2["default"].cyan("$ now help list")+"\n")},path=argv._[0];path?"/"!==path[0]&&(path=(0,_path.resolve)(process.cwd(),path)):path=process.cwd();var exit=function(e){setTimeout(function(){return process.exit(e||0)},100)},debug=argv.debug,clipboard=!argv["no-clipboard"],force=argv.force,forceSync=argv.forceSync,shouldLogin=argv.login,apiUrl=argv.url||"https://api.zeit.co",config=cfg.read();argv.h||argv.help?(help(),exit(0)):argv.v||argv.version?(console.log(_chalk2["default"].bold("ùö´ now"),_package.version),process.exit(0)):!config.token||shouldLogin?(0,_login2["default"])(apiUrl).then(function(e){shouldLogin?(console.log("> Logged in successfully. Token saved in ~/.now.json"),process.exit(0)):sync(e)["catch"](function(e){(0,_error.error)("Unknown error: "+e.stack),process.exit(1)})})["catch"](function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),process.exit(1)}):sync(config.token)["catch"](function(e){(0,_error.error)("Unknown error: "+e.stack),process.exit(1)});