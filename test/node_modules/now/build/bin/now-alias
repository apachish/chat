#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(r[a]=e[a]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function indent(e,r){return e.split("\n").map(function(e){return" ".repeat(r)+e}).join("\n")}function findAlias(e,r){var a=void 0,t=void 0;/\./.test(e)?(t=(0,_toHost2["default"])(e),a="alias"):(t=e,a="uid");var n=r.find(function(e){return e[a]===t?(debug&&console.log("> [debug] matched alias "+e.uid+" by "+a+" "+t),!0):t+".now.sh"===e.alias?(debug&&console.log("> [debug] matched alias "+e.uid+" by url "+e.host),!0):!1});return n}var _map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),run=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var a,t,n,i,l,u,o,s,c,d,f,_,p,m,h;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:a=new _alias3["default"](apiUrl,e,{debug:debug}),t=argv._.slice(1),r.t0=subcommand,r.next="list"===r.t0?5:"ls"===r.t0?5:"remove"===r.t0?20:"rm"===r.t0?20:"add"===r.t0?53:"set"===r.t0?53:59;break;case 5:if(0===t.length){r.next=8;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return",exit(1));case 8:return r.next=10,a.list();case 10:return n=r.sent,i=new _map2["default"](n.map(function(e){return[e.uid,e.url]})),r.next=14,a.ls();case 14:return l=r.sent,l.sort(function(e,r){return new Date(r.created)-new Date(e.created)}),u=new Date,o=(0,_textTable2["default"])(l.map(function(e){var r=_chalk2["default"].underline("https://"+e.alias),a=e.deploymentId,t=i.get(a)?_chalk2["default"].underline("https://"+i.get(a)):_chalk2["default"].gray("<null>"),n=_chalk2["default"].gray((0,_ms2["default"])(u-new Date(e.created))+" ago");return["",null==e.uid?"":e.uid,t,r,n]}),{align:["l","r","l"],hsep:" ".repeat(3)}),o&&console.log("\n"+o+"\n"),r.abrupt("break",65);case 20:if(s=String(t[0])){r.next=25;break}throw c=new Error("No alias id specified"),c.userError=!0,c;case 25:if(1===t.length){r.next=28;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return",exit(1));case 28:return r.next=30,a.ls();case 30:if(d=r.sent,f=findAlias(s,d)){r.next=36;break}throw _=new Error('Alias not found by "'+s+'". Run '+_chalk2["default"].dim("`now alias ls`")+" to see your aliases."),_.userError=!0,_;case 36:return r.prev=36,r.next=39,readConfirmation(a,f,d);case 39:return p=r.sent.toLowerCase(),"y"!==p&&"yes"!==p&&(console.log("\n> Aborted"),process.exit(0)),m=new Date,r.next=44,a.rm(f);case 44:h=(0,_ms2["default"])(new Date-m),console.log(_chalk2["default"].cyan("> Success!")+" Alias "+_chalk2["default"].bold(f.uid)+" removed ["+h+"]"),r.next=52;break;case 48:r.prev=48,r.t1=r["catch"](36),(0,_error.error)(r.t1),exit(1);case 52:return r.abrupt("break",65);case 53:if(2===t.length){r.next=56;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return",exit(1));case 56:return r.next=58,a.set(String(t[0]),String(t[1]));case 58:return r.abrupt("break",65);case 59:if(2!==argv._.length){r.next=64;break}return r.next=62,a.set(String(argv._[0]),String(argv._[1]));case 62:r.next=65;break;case 64:argv._.length>=3?((0,_error.error)("Invalid number of arguments"),help(),exit(1)):((0,_error.error)("Please specify a valid subcommand: ls | set | rm"),help(),exit(1));case 65:a.close();case 66:case"end":return r.stop()}},r,this,[[36,48]])}));return function(r){return e.apply(this,arguments)}}(),readConfirmation=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,a,t){var n,i;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.list();case 2:return n=r.sent,i=new _map2["default"](n.map(function(e){return[e.uid,e.url]})),r.abrupt("return",new _promise2["default"](function(e,r){var t=_chalk2["default"].gray((0,_ms2["default"])(new Date-new Date(a.created))+" ago"),n=_chalk2["default"].underline("https://"+i.get(a.deploymentId)),l=(0,_textTable2["default"])([[a.uid,n,_chalk2["default"].underline("https://"+a.alias),t]],{align:["l","r","l"],hsep:" ".repeat(6)});process.stdout.write("> The following deployment will be removed permanently\n"),process.stdout.write("  "+l+"\n"),process.stdout.write("  "+_chalk2["default"].bold.red("> Are you sure?")+" "+_chalk2["default"].gray("[yN] ")),process.stdin.on("data",function(r){process.stdin.pause(),e(r.toString().trim())}).resume()}));case 5:case"end":return r.stop()}},r,this)}));return function(r,a,t){return e.apply(this,arguments)}}(),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_textTable=require("text-table"),_textTable2=_interopRequireDefault(_textTable),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_alias2=require("../lib/alias"),_alias3=_interopRequireDefault(_alias2),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_error=require("../lib/error"),_toHost=require("../lib/to-host"),_toHost2=_interopRequireDefault(_toHost),argv=(0,_minimist2["default"])(process.argv.slice(2),{"boolean":["help","debug"],alias:{help:"h",debug:"d"}}),subcommand=argv._[0],help=function(){console.log("\n  "+_chalk2["default"].bold("ùö´ now alias")+" <ls | set | rm> <deployment> <alias>\n\n  "+_chalk2["default"].dim("Options:")+"\n\n    -h, --help   output usage information\n    -d, --debug  debug mode [off]\n\n  "+_chalk2["default"].dim("Examples:")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Lists all your aliases:\n\n      "+_chalk2["default"].cyan("$ now alias ls")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Adds a new alias to "+_chalk2["default"].underline("my-api.now.sh")+":\n\n      "+_chalk2["default"].cyan("$ now alias set "+_chalk2["default"].underline("api-ownv3nc9f8.now.sh")+" "+_chalk2["default"].underline("my-api.now.sh"))+"\n\n      The "+_chalk2["default"].dim("`.now.sh`")+" suffix can be ommited:\n\n      "+_chalk2["default"].cyan("$ now alias set api-ownv3nc9f8 my-api")+"\n\n      The deployment id can be used as the source:\n\n      "+_chalk2["default"].cyan("$ now alias set deploymentId my-alias")+"\n\n      Custom domains work as alias targets:\n\n      "+_chalk2["default"].cyan("$ now alias set "+_chalk2["default"].underline("api-ownv3nc9f8.now.sh")+" "+_chalk2["default"].underline("my-api.com"))+"\n\n      "+_chalk2["default"].dim("‚Äì")+" The subcommand "+_chalk2["default"].dim("`set`")+" is the default and can be skipped.\n      "+_chalk2["default"].dim("‚Äì")+" "+_chalk2["default"].dim("`http(s)://`")+" in the URLs is unneeded / ignored.\n\n  "+_chalk2["default"].gray("‚Äì")+" Removing an alias:\n\n      "+_chalk2["default"].cyan("$ now alias rm aliasId")+"\n\n      To get the list of alias ids, use "+_chalk2["default"].dim("`now alias ls`")+".\n\n  "+_chalk2["default"].dim("Alias:")+" ln\n")},debug=argv.debug,apiUrl=argv.url||"https://api.zeit.co",exit=function(e){setTimeout(function(){return process.exit(e||0)},100)};if(argv.help||!subcommand)help(),exit(0);else{var config=cfg.read();_promise2["default"].resolve(config.token||(0,_login2["default"])(apiUrl)).then(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,run(e);case 3:r.next=9;break;case 5:r.prev=5,r.t0=r["catch"](0),r.t0.userError?(0,_error.error)(r.t0.message):(0,_error.error)("Unknown error: "+r.t0.stack),exit(1);case 9:case"end":return r.stop()}},r,void 0,[[0,5]])}));return function(r){return e.apply(this,arguments)}}())["catch"](function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),exit(1)})}