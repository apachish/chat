#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(r[a]=e[a]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function indent(e,r){return e.split("\n").map(function(e){return" ".repeat(r)+e}).join("\n")}function findDomain(e,r){return r.find(function(r){return r.uid===e?(debug&&console.log("> [debug] matched domain "+r.uid+" by uid"),!0):r.name===(0,_toHost2["default"])(e)?(debug&&console.log("> [debug] matched domain "+r.uid+" by name "+r.name),!0):!1})}var _map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),run=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var a,t,n,l,o,u,i,d,s,c,f,_,m,h,p,g,k,b,w;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:a=new _domains3["default"](apiUrl,e,{debug:debug}),t=argv._.slice(1),r.t0=subcommand,r.next="ls"===r.t0?5:"list"===r.t0?5:"rm"===r.t0?16:"remove"===r.t0?16:"add"===r.t0?49:"set"===r.t0?49:62;break;case 5:if(0===t.length){r.next=8;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return",exit(1));case 8:return r.next=10,a.ls();case 10:return n=r.sent,n.sort(function(e,r){return new Date(r.created)-new Date(e.created)}),l=new Date,o=(0,_textTable2["default"])(n.map(function(e){var r=_chalk2["default"].underline("https://"+e.name),a=_chalk2["default"].gray((0,_ms2["default"])(l-new Date(e.created))+" ago");return["",e.uid,r,a]}),{align:["l","r","l"],hsep:" ".repeat(3)}),o&&console.log("\n"+o+"\n"),r.abrupt("break",65);case 16:if(1===t.length){r.next=19;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return",exit(1));case 19:if(u=String(t[0])){r.next=24;break}throw i=new Error("No domain specified"),i.userError=!0,i;case 24:return r.next=26,a.ls();case 26:if(d=r.sent,s=findDomain(u,d)){r.next=32;break}throw c=new Error('Domain not found by "'+u+'". Run '+_chalk2["default"].dim("`now domains ls`")+" to see your domains."),c.userError=!0,c;case 32:return r.prev=32,r.next=35,readConfirmation(a,s,d);case 35:return f=r.sent.toLowerCase(),"y"!==f&&"yes"!==f&&(console.log("\n> Aborted"),process.exit(0)),_=new Date,r.next=40,a.rm(s.name);case 40:m=(0,_ms2["default"])(new Date-_),console.log(_chalk2["default"].cyan("> Success!")+" Domain "+_chalk2["default"].bold(s.uid)+" removed ["+m+"]"),r.next=48;break;case 44:r.prev=44,r.t1=r["catch"](32),(0,_error.error)(r.t1),exit(1);case 48:return r.abrupt("break",65);case 49:if(1===t.length){r.next=52;break}return(0,_error.error)("Invalid number of arguments"),r.abrupt("return",exit(1));case 52:return h=new Date,p=String(t[0]),r.next=56,a.add(p);case 56:return g=r.sent,k=g.uid,b=g.created,w=(0,_ms2["default"])(new Date-h),b?console.log(_chalk2["default"].cyan("> Success!")+" Domain "+_chalk2["default"].bold(_chalk2["default"].underline(p))+" "+_chalk2["default"].dim("("+k+")")+" added ["+w+"]"):console.log(_chalk2["default"].cyan("> Success!")+" Domain "+_chalk2["default"].bold(_chalk2["default"].underline(p))+" "+_chalk2["default"].dim("("+k+")")+" already exists ["+w+"]"),r.abrupt("break",65);case 62:(0,_error.error)("Please specify a valid subcommand: ls | add | rm"),help(),exit(1);case 65:a.close();case 66:case"end":return r.stop()}},r,this,[[32,44]])}));return function(r){return e.apply(this,arguments)}}(),readConfirmation=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,a,t){var n;return _regenerator2["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new _map2["default"](t.map(function(e){return[e.uid,e.url]})),e.abrupt("return",new _promise2["default"](function(e,r){var t=_chalk2["default"].gray((0,_ms2["default"])(new Date-new Date(a.created))+" ago"),n=(0,_textTable2["default"])([[a.uid,_chalk2["default"].underline("https://"+a.name),t]],{align:["l","r","l"],hsep:" ".repeat(6)});process.stdout.write("> The following deployment will be removed permanently\n"),process.stdout.write("  "+n+"\n"),process.stdout.write("  "+_chalk2["default"].bold.red("> Are you sure?")+" "+_chalk2["default"].gray("[yN] ")),process.stdin.on("data",function(r){process.stdin.pause(),e(r.toString().trim())}).resume()}));case 2:case"end":return e.stop()}},r,this)}));return function(r,a,t){return e.apply(this,arguments)}}(),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_textTable=require("text-table"),_textTable2=_interopRequireDefault(_textTable),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_error=require("../lib/error"),_toHost=require("../lib/to-host"),_toHost2=_interopRequireDefault(_toHost),_domains2=require("../lib/domains"),_domains3=_interopRequireDefault(_domains2),argv=(0,_minimist2["default"])(process.argv.slice(2),{"boolean":["help","debug"],alias:{help:"h",debug:"d"}}),subcommand=argv._[0],help=function(){console.log("\n  "+_chalk2["default"].bold("ùö´ now domains")+" <ls | set | rm> <domain>\n\n  "+_chalk2["default"].dim("Options:")+"\n\n    -h, --help   output usage information\n    -d, --debug  debug mode [off]\n\n  "+_chalk2["default"].dim("Examples:")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Lists all your domains:\n\n      "+_chalk2["default"].cyan("$ now domains ls")+"\n\n  "+_chalk2["default"].gray("‚Äì")+" Adds a domain name:\n\n      "+_chalk2["default"].cyan("$ now domains add "+_chalk2["default"].underline("my-app.com"))+"\n\n      Make sure the domain's DNS nameservers are at least 2 of these:\n\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("california.zeit.world")+"    "+_chalk2["default"].dim("173.255.215.107")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("london.zeit.world")+"        "+_chalk2["default"].dim("178.62.47.76")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("newark.zeit.world")+"        "+_chalk2["default"].dim("173.255.231.87")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("amsterdam.zeit.world")+"     "+_chalk2["default"].dim("188.226.197.55")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("dallas.zeit.world")+"        "+_chalk2["default"].dim("173.192.101.194")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("paris.zeit.world")+"         "+_chalk2["default"].dim("37.123.115.172")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("singapore.zeit.world")+"     "+_chalk2["default"].dim("119.81.97.170")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("sydney.zeit.world")+"        "+_chalk2["default"].dim("52.64.171.200")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("frankfurt.zeit.world")+"     "+_chalk2["default"].dim("91.109.245.139")+"\n      "+_chalk2["default"].gray("‚Äì")+" "+_chalk2["default"].underline("iowa.zeit.world")+"          "+_chalk2["default"].dim("23.236.59.22")+"\n\n      "+_chalk2["default"].yellow("NOTE:")+" running "+_chalk2["default"].dim("`now alias`")+" will automatically register your domain\n      if it's configured with these nameservers (no need to "+_chalk2["default"].dim("`domain add`")+").\n\n      For more details head to "+_chalk2["default"].underline("https://zeit.world")+".\n\n  "+_chalk2["default"].gray("‚Äì")+" Removing a domain:\n\n      "+_chalk2["default"].cyan("$ now domain rm my-app.com")+"\n\n      or\n\n      "+_chalk2["default"].cyan("$ now domain rm domainId")+"\n\n      To get the list of domain ids, use "+_chalk2["default"].dim("`now domains ls`")+".\n")},debug=argv.debug,apiUrl=argv.url||"https://api.zeit.co",exit=function(e){setTimeout(function(){return process.exit(e||0)},100)};if(argv.help||!subcommand)help(),exit(0);else{var config=cfg.read();_promise2["default"].resolve(config.token||(0,_login2["default"])(apiUrl)).then(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,run(e);case 3:r.next=9;break;case 5:r.prev=5,r.t0=r["catch"](0),r.t0.userError?(0,_error.error)(r.t0.message):(0,_error.error)("Unknown error: "+r.t0.stack),exit(1);case 9:case"end":return r.stop()}},r,void 0,[[0,5]])}));return function(r){return e.apply(this,arguments)}}())["catch"](function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),exit(1)})}